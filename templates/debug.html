<!-- templates/debug.html -->
{% extends "base.html" %}

{% block content %}
<h2>Debug Page</h2>
<button class="btn btn-secondary" id="publish-btn">Publish to Topic</button>
<div id="publish-response" class="mt-3"></div>

<!-- Modal for publishing topic -->
<div class="modal fade" id="publishModal" tabindex="-1" role="dialog" aria-labelledby="publishModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="publishModalLabel">Publish to Topic</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="publish-form">
          <div class="form-group">
            <label for="topic-input">Topic Name</label>
            <input type="text" class="form-control" id="topic-input" placeholder="/topic">
          </div>
          <div class="form-group">
            <label for="msg-type-select">Message Type</label>
            <select class="form-control" id="msg-type-select">
              <option value="std_msgs/String">std_msgs/String</option>
              <option value="std_msgs/Int32">std_msgs/Int32</option>
              <option value="std_msgs/ColorRGBA">std_msgs/ColorRGBA</option>
            </select>
          </div>
          <div id="fields-container">
            <!-- Dynamic fields will be inserted here based on message type -->
          </div>
          <button type="submit" class="btn btn-primary">Publish</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function(){
      var socket = io();
      
      // When the publish button is clicked, show the modal and update fields.
      $('#publish-btn').click(function(){
          $('#publishModal').modal('show');
          updateFields();
      });
      
      // Update fields when the message type is changed.
      $('#msg-type-select').change(function(){
          updateFields();
      });
      
      function updateFields(){
          var msgType = $('#msg-type-select').val();
          var container = $('#fields-container');
          container.empty();
          // Define fields for each supported std_msgs type.
          var fields = [];
          if(msgType === 'std_msgs/String'){
              fields.push({name: 'data', label: 'Data', type: 'text'});
          } else if(msgType === 'std_msgs/Int32'){
              fields.push({name: 'data', label: 'Data', type: 'number'});
          } else if(msgType === 'std_msgs/ColorRGBA'){
              fields.push({name: 'r', label: 'Red', type: 'number', step: '0.1'});
              fields.push({name: 'g', label: 'Green', type: 'number', step: '0.1'});
              fields.push({name: 'b', label: 'Blue', type: 'number', step: '0.1'});
              fields.push({name: 'a', label: 'Alpha', type: 'number', step: '0.1'});
          }
          fields.forEach(function(field){
              container.append(`
                  <div class="form-group">
                      <label for="${field.name}-input">${field.label}</label>
                      <input type="${field.type}" class="form-control" id="${field.name}-input" name="${field.name}" ${field.step ? 'step="'+field.step+'"' : ''}>
                  </div>
              `);
          });
      }
      
      $('#publish-form').submit(function(e){
          e.preventDefault();
          var topic = $('#topic-input').val();
          var msgType = $('#msg-type-select').val();
          var fields = {};
          $('#fields-container input').each(function(){
              var fieldName = $(this).attr('name');
              var fieldValue = $(this).val();
              fields[fieldName] = fieldValue;
          });
          socket.emit('publish_topic', {topic: topic, msg_type: msgType, fields: fields});
      });
      
      socket.on('publish_response', function(data){
          $('#publish-response').html('<pre>' + JSON.stringify(data, null, 2) + '</pre>');
          $('#publishModal').modal('hide');
      });
  });
</script>
{% endblock %}
