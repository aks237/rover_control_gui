{% extends "base.html" %}

{% block content %}
<h2>Camera Feeds</h2>
<div class="row">
  <!-- ZED Column -->
  <div class="col-md-4 text-center">
    <button class="btn btn-primary command-btn" data-category="ZED" data-command="run_zed">Run ZED Node</button>
    <div class="mt-3 mb-3">
      <img id="zed-feed" src="#" alt="ZED Feed" style="width:100%;">
    </div>
    <button class="btn btn-danger kill-btn" data-command="kill_zed">Kill ZED Node</button>
  </div>

  <!-- Stitched Column -->
  <div class="col-md-4 text-center">
    <button class="btn btn-primary command-btn" data-category="Stitched" data-command="run_stitched">Run Stitched Node</button>
    <div class="mt-3 mb-3">
      <img id="stitched-feed" src="#" alt="Stitched Feed" style="width:100%;">
    </div>
    <button class="btn btn-danger kill-btn" data-command="kill_stitched">Kill Stitched Node</button>
  </div>

  <!-- End Effector Column -->
  <div class="col-md-4 text-center">
    <button class="btn btn-primary command-btn" data-category="EndEffector" data-command="run_ee">Run End Effector Node</button>
    <div class="mt-3 mb-3">
      <img id="ee-feed" src="#" alt="End Effector Feed" style="width:100%;">
    </div>
    <button class="btn btn-danger kill-btn" data-command="kill_ee">Kill End Effector Node</button>
  </div>
</div>

<!-- Terminal Output -->
<div class="mt-4">
  <h4>Latest Terminal Output</h4>
  <pre id="output-box" style="background:#222; color:#eee; padding:1em; height:200px; overflow:auto;"></pre>
</div>

<script>
  $(document).ready(function(){
      var socket = io();

      $('.command-btn').click(function(){
          var command_name = $(this).data('command');
          var category = $(this).data('category');
          socket.emit('command', {command_name: command_name, category: category});
      });

      $('.kill-btn').click(function(){
          var command_name = $(this).data('command');
          socket.emit('kill_command', {command_name: command_name});
      });

      socket.on('command_response', function(data){
          let output = '';
          if (data.error) {
              output += `ERROR: ${data.error}\n`;
          } else {
              output += `> ${data.command}\n\n`;
              if (data.stdout) output += `stdout:\n${data.stdout}\n`;
              if (data.stderr) output += `stderr:\n${data.stderr}\n`;
          }
          document.getElementById("output-box").textContent = output;
      });

      socket.on('kill_response', function(data){
          let output = '';
          if (data.error) {
              output += `ERROR: ${data.error}\n`;
          } else {
              output += `${data.status}\n\n`;
              if (data.stdout) output += `stdout:\n${data.stdout}\n`;
              if (data.stderr) output += `stderr:\n${data.stderr}\n`;
          }
          document.getElementById("output-box").textContent = output;
      });
  });

  // Refresh images every second
  setInterval(() => {
    const t = new Date().getTime();
    document.getElementById("zed-feed").src = "/image_feed?" + t;
    document.getElementById("stitched-feed").src = "/stitched_feed?" + t;
  }, 50);
</script>
{% endblock %}
